

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.3. Heap &mdash; bin-sec 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9. 栈相关漏洞" href="../stack/index.html" />
    <link rel="prev" title="8.2. Stack" href="stack.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> bin-sec
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../basic/index.html">1. 基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">2. 计算机体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../firmware/index.html">3. 固件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../assembly/index.html">4. 汇编基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compile/index.html">5. 编译原理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../os/index.html">6. 操作系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reverse/index.html">7. 逆向工程</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">8. 漏洞利用基础</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="shellcode.html">8.1. Shellcode</a></li>
<li class="toctree-l2"><a class="reference internal" href="stack.html">8.2. Stack</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.3. Heap</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">8.3.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="#chunk">8.3.2. Chunk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bins">8.3.3. Bins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#malloc">8.3.4. Malloc逻辑</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">8.3.4.1. malloc检查</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#free">8.3.5. free机制</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">8.3.6. 其他情况</a></li>
<li class="toctree-l3"><a class="reference internal" href="#references">8.3.7. References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../stack/index.html">9. 栈相关漏洞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heap/index.html">10. 堆相关漏洞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vulns/index.html">11. 其他漏洞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mitigations/index.html">12. 防御策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">13. 工具与资源</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/index.html">14. 其他</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">bin-sec</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">8. 漏洞利用基础</a> &raquo;</li>
        
      <li>8.3. Heap</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/exploit/heap.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="heap">
<h1>8.3. Heap<a class="headerlink" href="#heap" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>8.3.1. 简介<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>目前各平台有dlmalloc、ptmalloc2、jemalloc、tcmalloc、libumem等堆内存管理机制。</p>
<p><code class="docutils literal notranslate"><span class="pre">ptmalloc2</span></code> 来自于 <code class="docutils literal notranslate"><span class="pre">dlmalloc</span></code> 的分支。此后，添加线程支持并于2006年发布。正式发布后， <code class="docutils literal notranslate"><span class="pre">patmalloc2</span></code> 集成到glibc源码中。随着源码集成，代码修改便直接在glibc <code class="docutils literal notranslate"><span class="pre">malloc</span></code> 源码里进行。因此 <code class="docutils literal notranslate"><span class="pre">ptmalloc2</span></code> 与glibc之间的 <code class="docutils literal notranslate"><span class="pre">malloc</span></code> 实现有很多不同。</p>
<p>在早期的Linux里， <code class="docutils literal notranslate"><span class="pre">dlmalloc</span></code> 被用做默认的内存分配器。但之后因为 <code class="docutils literal notranslate"><span class="pre">ptmalloc2</span></code> 添加了线程支持， <code class="docutils literal notranslate"><span class="pre">ptmalloc2</span></code> 成为了Linux默认内存分配器。线程支持可帮助提升内存分配器以及应用程序的性能。</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">dlmalloc</span></code> 里，当两个线程同时调用 <code class="docutils literal notranslate"><span class="pre">malloc</span></code> 时，只有一个线程能进入到临界段，因为这里的空闲列表数据结构是所有可用线程共用的。因此内存分配器要在多线程应用里耗费时间，从而导致性能降低。</p>
<p>然而在 <code class="docutils literal notranslate"><span class="pre">ptmalloc2</span></code> 里，当两个线程同时调用 <code class="docutils literal notranslate"><span class="pre">malloc</span></code> 时，会立即分配内存。因为每个线程维护一个单独的堆分段，因此空闲列表数据结构正在维护的这些堆也是独立的。这种维护独立堆以及每一个线程享有空闲列表数据结构的行为被称为Per Thread Arena。</p>
<p>在下文中，主要对glibc使用的ptmalloc2进行介绍。</p>
</div>
<div class="section" id="chunk">
<h2>8.3.2. Chunk<a class="headerlink" href="#chunk" title="Permalink to this headline">¶</a></h2>
<p>在内存中，堆（低地址到高地址，属性RW）有两种分配方式（与malloc申请chunk做区分）:</p>
<ul class="simple">
<li><p>mmap: 当申请的size大于128kb时，由mmap分配</p></li>
<li><p>brk: 当申请的size小于128kb时，由brk分配，第一次分配132KB（main arena），第二次在brk下分配，不够则执行系统调用，向系统申请</p></li>
</ul>
<p>在内存中进行堆的管理时，系统基本是以chunk作为基本单位，chunk的结构在源码中有定义</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="p">{</span>

  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">mchunk_prev_size</span><span class="p">;</span>  <span class="cm">/* Size of previous chunk (if free).  */</span>
  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">mchunk_size</span><span class="p">;</span>       <span class="cm">/* Size in bytes, including overhead. */</span>

  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">fd</span><span class="p">;</span>         <span class="cm">/* double links -- used only if free. */</span>
  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">bk</span><span class="p">;</span>

  <span class="cm">/* Only used for large blocks: pointer to next larger size.  */</span>
  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">fd_nextsize</span><span class="p">;</span> <span class="cm">/* double links -- used only if free. */</span>
  <span class="k">struct</span> <span class="n">malloc_chunk</span><span class="o">*</span> <span class="n">bk_nextsize</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>chunk的状态可以分为三种：allocated chunk、free chunk、top chunk</p>
</div>
<div class="section" id="bins">
<h2>8.3.3. Bins<a class="headerlink" href="#bins" title="Permalink to this headline">¶</a></h2>
<p>Bin在内存中用来管理free chunk，bin为带有头结点（链表头部不是chunk）的链表数组，根据特点，将bin分为四种，分别为：fastbin、unsortedbin、smallbin、largebin。</p>
<ul class="simple">
<li><dl class="simple">
<dt>fastbin</dt><dd><ul>
<li><p>根据chunk大小维护多个单向链表</p></li>
<li><p>sizeof(chunk) &lt; 64(bytes)</p></li>
<li><p>下一chunk（内存中）的free标志位不取消，显示其仍在使用</p></li>
<li><p>后进先出（类似栈），先free的先被malloc</p></li>
<li><p>拥有维护固定大小chunk的10个链表</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>unsortedbin</dt><dd><ul>
<li><p>双向循环链表</p></li>
<li><p>不排序</p></li>
<li><p>暂时存储free后的chunk，一段时间后将chunk放入对应的bin中</p></li>
<li><p>只有一个链表</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>smallbin</dt><dd><ul>
<li><p>双向循环链表</p></li>
<li><p>sizeof(chunk) &lt; 512 (bytes)</p></li>
<li><p>先进先出（类似队列）</p></li>
<li><p>16,24,…,64,72,…,508 bytes(62个链表)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>largebin</dt><dd><ul>
<li><p>双向循环链表</p></li>
<li><p>sizeof(chunk) &gt;= 512 (bytes)</p></li>
<li><p>free chunk中多两个指针分别指向前后的large chunk</p></li>
<li><dl class="simple">
<dt>63个链表</dt><dd><ul>
<li><p>0-31(512+64*i)</p></li>
<li><p>32-48(2496+512*i)</p></li>
<li><p>…</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>链表中chunk大小不固定，先大后小</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="malloc">
<h2>8.3.4. Malloc逻辑<a class="headerlink" href="#malloc" title="Permalink to this headline">¶</a></h2>
<p>当接收到申请内存的请求时，malloc的处理逻辑如下</p>
<ul class="simple">
<li><dl class="simple">
<dt>申请长度位于 fastbin 时</dt><dd><ul>
<li><p>根据大小获得fastbin的index</p></li>
<li><dl class="simple">
<dt>根据index获取fastbin中链表的头指针</dt><dd><ul>
<li><p>如果头指针为 NULL，转去smallbin</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>将头指针的下一个chunk地址作为链表头指针</p></li>
<li><p>分配的chunk保持inuse状态，避免被合并</p></li>
<li><p>返回除去chunk_header的地址</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>长度位于 smallbin 时</dt><dd><ul>
<li><p>根据大小获得smallbin的index</p></li>
<li><p>根据index获取smallbin中双向循环链表的头指针</p></li>
<li><dl class="simple">
<dt>将链表最后一个chunk赋值给victim</dt><dd><ul>
<li><p>若victim为表头，此时链表为空，不从smallbin中分配</p></li>
<li><p>若victim为0，此时链表未初始化，将fastbin中的chunk合并</p></li>
<li><p>其他情况取出victim,设置inuse</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>检查victim是否为main_arena,设置标志位</p></li>
<li><p>返回除去chunk_header的地址</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>长度位于 largebin 时</dt><dd><ul>
<li><p>根据大小获得largebin的index</p></li>
<li><p>将fastbin中chunk合并，加入到unsortbin中</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>进一步处理</p>
<ul class="simple">
<li><dl class="simple">
<dt>unsortedbin</dt><dd><ul>
<li><p>反向遍历unsortedbin,检查 2*size_t&lt;chunk_size&lt;内存总分配量</p></li>
<li><dl class="simple">
<dt>unsortedbin的特殊分配</dt><dd><ul>
<li><p>如果前一步smallbin分配未完成</p></li>
<li><p>并且 unsortedbin中只有一个chunk</p></li>
<li><p>并且该chunk为 last remainder chunk</p></li>
<li><p>并且该chunk大小 &gt;（所需大小+最小分配大小）</p></li>
<li><p>则切分一块分配</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>如果请求大小正好等于当前遍历chunk的大小，则直接分配</p></li>
<li><p>继续遍历，将合适大小的chunk加入到smallbin中，向前插入作为链表的第一个chunk。(smallbin中每个链表中chunk大小相同)</p></li>
<li><p>将合适大小的chunk加入到largebin中，插入到合适的位置（largebin中每个链表chunk由大到小排列）</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>largebin</dt><dd><ul>
<li><dl class="simple">
<dt>反向遍历largebin，由下到上查找，找到合适大小后切分</dt><dd><p>切分后大小&lt;最小分配大小，返回整个chunk，会略大于申请大小
切分后大小&gt;最小分配大小，加入 unsortedbin。</p>
</dd>
</dl>
</li>
<li><p>未找到，index+1，继续寻找</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>如果这之后还未找到合适的chunk，就会使用top chunk进行分配，还是没有的话，如果在多线程环境中，fastbin可能会有新的chunk，再次执行合并，并向unsortedbin中重复上面的步骤，之后还是没有的话，就只能向系统申请。</p>
<p>以上为malloc分配的经过</p>
<div class="section" id="id2">
<h3>8.3.4.1. malloc检查<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>从fastbin中取出chunk后，检查size是否属于fastbin</p></li>
<li><p>从smallbin中除去chunk后，检查victim-&gt;bk-&gt;fd == victim</p></li>
<li><p>从unsortbin取chunk时，要检查2*size_t&lt;chunk_size&lt;内存总分配量</p></li>
<li><p>从largebin取chunk时，切分后的chunk要加入unsortedbin,需要检查 unsortedbin的第一个chunk的bk是否指向unsortedbin</p></li>
</ul>
</div>
</div>
<div class="section" id="free">
<h2>8.3.5. free机制<a class="headerlink" href="#free" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>使用 chunksize(p) 宏获取p的size</p></li>
<li><dl class="simple">
<dt>安全检查</dt><dd><ul>
<li><p>chunk的指针地址不能溢出</p></li>
<li><p>chunk 的大小 &gt;= MINSIZE(最小分配大小)，并且检查地址是否对齐</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>大小为fastbin时</dt><dd><ul>
<li><p>检查下一个chunk的size：2*size_t&lt;chunk_size&lt;内存总分配量</p></li>
<li><p>double free检查：检查当前free的chunk是否与fastbin中的第一个chunk相同，相同则报错</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="id3">
<h2>8.3.6. 其他情况<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>检查下一个chunk的size</dt><dd><ul>
<li><p>2*size_t&lt;chunk_size&lt;内存总分配量</p></li>
<li><p>如果当前 chunk 为 sbrk()分配，那么它相邻的下一块 chunk 超过了分配区的地址，会报错</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>double free检查</dt><dd><ul>
<li><p>检查当前free的chunk是否为top chunk，是则报错</p></li>
<li><p>根据下一块的inuse标识检查当前free的chunk是否已被free</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>unlink合并</dt><dd><ul>
<li><p>检查前后chunk是否free，然后向后（top chunk方向）合并，并改变对应的inuse标志位</p></li>
<li><dl class="simple">
<dt>unlink检查</dt><dd><ul>
<li><p>I.当前chunk的size是否等于下一chunk的prev_size</p></li>
<li><p>II.P-&gt;bk-&gt;fd == P &amp;&amp; P-&gt;bk-&gt;fd == P</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>如果合并后 chunk_size &gt; 64bytes,则调用函数合并fastbin中的chunk到unsortedbin中</p></li>
<li><p>将合并后的chunk加入unsortedbin</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>unsortedbin检查</dt><dd><ul>
<li><p>检查 unsortedbin的第一个chunk的bk是否指向unsortedbin</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="references">
<h2>8.3.7. References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://wps2015.org/drops/drops/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20glibc%20malloc.html">深入理解</a></p></li>
<li><p><a class="reference external" href="http://www.malloc.de/en/">malloc homepage</a></p></li>
<li><p><a class="reference external" href="http://g.oswego.edu/dl/html/malloc.html">Memory Allocator</a></p></li>
<li><p><a class="reference external" href="http://www.freebuf.com/articles/system/151372.html">Dance in Heap 1</a></p></li>
<li><p><a class="reference external" href="https://www.cnblogs.com/alisecurity/p/5486458.html">Linux堆管理分析</a></p></li>
<li><p><a class="reference external" href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/comment-page-1/">Understanding glibc malloc</a></p></li>
<li><p><a class="reference external" href="https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/">syscalls-used-by-malloc</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../stack/index.html" class="btn btn-neutral float-right" title="9. 栈相关漏洞" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="stack.html" class="btn btn-neutral float-left" title="8.2. Stack" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, lyle

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
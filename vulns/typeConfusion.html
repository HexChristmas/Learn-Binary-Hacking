

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2.4. Type Confusion &mdash; bin-sec 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2.5. User After Free" href="uaf.html" />
    <link rel="prev" title="2.3. 格式化字符串" href="fmtstr.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> bin-sec
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../basic/index.html">1. 基础知识</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">2. 漏洞</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="rop.html">2.1. rop</a></li>
<li class="toctree-l2"><a class="reference internal" href="offByOne.html">2.2. off-by-one</a></li>
<li class="toctree-l2"><a class="reference internal" href="fmtstr.html">2.3. 格式化字符串</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2.4. Type Confusion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#desc">2.4.1. Desc</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#description-summary">2.4.1.1. Description Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extended-description">2.4.1.2. Extended Description</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example">2.4.2. Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="uaf.html">2.5. User After Free</a></li>
<li class="toctree-l2"><a class="reference internal" href="stackoverflow.html">2.6. 栈溢出</a></li>
<li class="toctree-l2"><a class="reference internal" href="heapoverflow.html">2.7. 堆溢出</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mitigations/index.html">3. 保护机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">4. 工具</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">bin-sec</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">2. 漏洞</a> &raquo;</li>
        
      <li>2.4. Type Confusion</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/vulns/typeConfusion.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="type-confusion">
<h1>2.4. Type Confusion<a class="headerlink" href="#type-confusion" title="Permalink to this headline">¶</a></h1>
<div class="section" id="desc">
<h2>2.4.1. Desc<a class="headerlink" href="#desc" title="Permalink to this headline">¶</a></h2>
<div class="section" id="description-summary">
<h3>2.4.1.1. Description Summary<a class="headerlink" href="#description-summary" title="Permalink to this headline">¶</a></h3>
<p>The program allocates or initializes a resource such as a pointer, object, or variable using one type, but it later accesses that resource using a type that is incompatible with the original type.</p>
</div>
<div class="section" id="extended-description">
<h3>2.4.1.2. Extended Description<a class="headerlink" href="#extended-description" title="Permalink to this headline">¶</a></h3>
<p>When the program accesses the resource using an incompatible type, this could trigger logical errors because the resource does not have expected properties. In languages without memory safety, such as C and C++, type confusion can lead to out-of-bounds memory access.</p>
<p>While this weakness is frequently associated with unions when parsing data with many different embedded object types in C, it can be present in any application that can interpret the same variable or memory location in multiple ways.</p>
<p>This weakness is not unique to C and C++. For example, errors in PHP applications can be triggered by providing array parameters when scalars are expected, or vice versa. Languages such as Perl, which perform automatic conversion of a variable of one type when it is accessed as if it were another type, can also contain these issues.</p>
</div>
</div>
<div class="section" id="example">
<h2>2.4.2. Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define NAME_TYPE 1</span>
<span class="c1">#define ID_TYPE 2</span>

<span class="n">struct</span> <span class="n">MessageBuffer</span>
<span class="p">{</span>
    <span class="nb">int</span> <span class="n">msgType</span><span class="p">;</span>
    <span class="n">union</span> <span class="p">{</span>
        <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
        <span class="nb">int</span> <span class="n">nameID</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">};</span>


<span class="nb">int</span> <span class="n">main</span> <span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">struct</span> <span class="n">MessageBuffer</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">defaultMessage</span> <span class="o">=</span> <span class="s2">&quot;Hello World&quot;</span><span class="p">;</span>

    <span class="n">buf</span><span class="o">.</span><span class="n">msgType</span> <span class="o">=</span> <span class="n">NAME_TYPE</span><span class="p">;</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">defaultMessage</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Pointer of buf.name is %p</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
    <span class="o">/*</span> <span class="n">This</span> <span class="n">particular</span> <span class="n">value</span> <span class="k">for</span> <span class="n">nameID</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">make</span> <span class="n">the</span> <span class="n">code</span> <span class="n">architecture</span><span class="o">-</span><span class="n">independent</span><span class="o">.</span> <span class="n">If</span> <span class="n">coming</span> <span class="kn">from</span> <span class="nn">untrusted</span> <span class="nb">input</span><span class="p">,</span> <span class="n">it</span> <span class="n">could</span> <span class="n">be</span> <span class="nb">any</span> <span class="n">value</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">nameID</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)(</span><span class="n">defaultMessage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Pointer of buf.name is now %p</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">msgType</span> <span class="o">==</span> <span class="n">NAME_TYPE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Message: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Message: Use ID </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">.</span><span class="n">nameID</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="uaf.html" class="btn btn-neutral float-right" title="2.5. User After Free" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fmtstr.html" class="btn btn-neutral" title="2.3. 格式化字符串" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, lyle.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>